AI Features & OpenAI Integration

This project includes several light, production-style AI integrations. All of them are optional and fully guarded behind environment variables, so tests and basic flows work even without any external services.

Where AI is used

Natural-language scheduling constraints
Endpoint: POST /constraints/parse

Input example:

"Try to book in the next two weeks, preferably Tueâ€“Thu mornings"

Behavior:

If OPENAI_API_KEY is set, the service uses OpenAI (via the official Python SDK) to parse this into structured JSON:

hard_constraints â†’ time window + timezone

soft_constraints â†’ preferred days of week / time of day

If the key is not set, a deterministic heuristic parser is used instead (this is what the tests rely on).

Availability parsing from call transcripts (Twilio voice)
Endpoint: POST /twilio/voice/gather

Twilio sends ASR transcripts and/or DTMF input from the live call.

If OPENAI_API_KEY is set, the transcript is parsed into one or more concrete availability slots inside the requested window and stored as ParticipantAvailability rows.

If not, a simple deterministic fallback is used.

Dynamic call script generation for IVR

When an outbound call is answered (/twilio/voice), the bot speaks a script inviting the lead to share availability.

If OPENAI_API_KEY is set, the script can be lightly personalized by OpenAI (short, friendly, single paragraph).

If not, a fixed hard-coded script is used.

How to turn AI features on

Install dependencies (including OpenAI + tzdata, if not already):

pip install -r requirements.txt


Set the OpenAI API key (optional but required for AI features):

PowerShell (Windows):

$env:OPENAI_API_KEY = "sk-proj-xxxxxxxxxxxxxxxx"


If OPENAI_API_KEY is not set, the app falls back to deterministic, test-friendly logic for all AI features.

Ownership & Legal Notice

Unless otherwise noted in specific files:

Copyright Â© 2025 Elyashiv Newman. All rights reserved.

This repository (code, configuration, and documentation) was created by Elyashiv Newman as part of a technical assignment.

All original source code, scripts, and accompanying materials in this project are the intellectual property of Elyashiv Newman and may not be copied, reused, or distributed without explicit permission, except where reuse is clearly allowed by referenced third-party licenses (e.g. libraries in requirements.txt).

If you intend to reuse or redistribute any part of this project beyond reviewing it for the assignment, please contact:

ðŸ“§ elyashiv.newman@mail.huji.ac.il

Architecture Overview

This project implements an AI-assisted outbound call center that books meetings for senior account managers.

High-level architecture:

UI / Client â†’ API â†’ Scheduler Worker â†’ Outbound Orchestrator â†’ Twilio â†’ Optimizer

API Layer (FastAPI)

Key endpoints:

POST /meeting-requests

Define what needs to be booked (owner, duration, constraints).

POST /campaigns

Attach leads to a meeting request.

POST /calls/test

Internal helper to trigger a test outbound call.

POST /twilio/voice and POST /twilio/voice/gather

Twilio webhooks for voice calls and availability collection.

POST /twilio/status

Twilio status callback to keep Call records in sync.

POST /constraints/parse

Natural-language constraint parsing (AI-backed when enabled).

Scheduler / Workers (scripts)

scripts/manual_call_demo.py
End-to-end manual demo:

Creates (or reuses) a lead.

Creates a MeetingRequest with a short booking window.

Triggers an outbound call via Twilio to a real phone number.

Twilio hits /twilio/voice â†’ /twilio/voice/gather.

The transcript / DTMF is converted into ParticipantAvailability.

scripts/scheduler_tick.py (optional pattern)

Batch-selects leads for a meeting request.

Hands them to the outbound orchestrator.

Outbound Orchestrator

Selects which leads to call next for a given meeting request.

Uses call_service.initiate_outbound_call to:

Create Call rows in the database.

Trigger an outbound call via TwilioClient.

Twilio Integration

POST /twilio/voice

Initial answer webhook.

Plays a short script and starts a <Gather> for speech/DTMF.

POST /twilio/voice/gather

Receives the gathered input (ASR transcript and/or DTMF).

Converts it into one or more availability windows and persists them as ParticipantAvailability.

POST /twilio/status

Receives Twilio call status events.

Updates the corresponding Call record in the database.

Optimizer / Scheduling

POST /meeting-requests/{id}/confirm-best-slot

Runs the optimization logic over all collected availability.

Picks the best slot and updates the MeetingRequest status.

Most of the flow is covered by automated tests (pytest), except for the manual scripts that intentionally talk to live Twilio/OpenAI.

Running the System from the Command Line
1. Set environment variables

Example (PowerShell, from repo root):

# Database
$env:DATABASE_URL = "sqlite:///./app.db"

# Twilio
$env:TWILIO_ACCOUNT_SID      = "ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
$env:TWILIO_AUTH_TOKEN       = "your_auth_token_here"
$env:TWILIO_PHONE_NUMBER     = "+1XXXXXXXXXX"
$env:TWILIO_VOICE_WEBHOOK_URL = "https://<your-ngrok-id>.ngrok-free.app/twilio/voice"

# OpenAI (optional â€“ deterministic fallbacks are used if omitted)
$env:OPENAI_API_KEY = "sk-proj-xxxxxxxxxxxxxxxx"


Make sure your ngrok (or equivalent) tunnel points to your running FastAPI server, e.g. http://localhost:8000.

2. Start the API
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

3. Create a Meeting Request (HTTP client / CLI)

Example with HTTPie
:

http POST :8000/meeting-requests \
  owner_id="am-cli" \
  title="CLI demo meeting" \
  duration_minutes:=30 \
  max_bookings:=3 \
  hard_constraints:='{
    "window_start": "2025-01-01T09:00:00+02:00",
    "window_end":   "2025-01-01T17:00:00+02:00",
    "timezone":     "Asia/Jerusalem"
  }'


For natural-language constraints, you can first call:

http POST :8000/constraints/parse \
  instruction="Try to book in the next two weeks, preferably Tueâ€“Thu mornings" \
  timezone="Asia/Jerusalem"


Then reuse the returned hard_constraints / soft_constraints.

4. Attach Leads (Campaigns)
http POST :8000/campaigns \
  name="CLI demo campaign" \
  meeting_request_id:=<MEETING_REQUEST_ID> \
  leads:='[
    {"name": "Alice", "phone": "+111111111", "email": "alice@example.com", "timezone": "Asia/Jerusalem"},
    {"name": "Bob",   "phone": "+222222222", "email": "bob@example.com",   "timezone": "Europe/London"}
  ]'

5. Run Workers / Orchestrator
Single-lead manual demo (real phone call)
python -m scripts.manual_call_demo


This script:

Inserts or reuses a Lead
(in the repo version, the default is the authorâ€™s phone number â€“ replace it with your own before running in production).

Creates a MeetingRequest with a short booking window.

Uses TwilioClient + initiate_outbound_call to place a real call.

Twilio hits /twilio/voice â†’ /twilio/voice/gather.

The transcript / DTMF is parsed into ParticipantAvailability rows.

Batch scheduler pattern (optional worker)
python -m scripts.scheduler_tick --meeting-request-id <ID> --max-calls 10


This worker:

Selects a batch of eligible leads for that meeting request.

Passes them to the outbound orchestrator, which triggers outbound calls via Twilio.

6. Confirm the Best Slot (Optimization)

After enough availability has been collected:

http POST :8000/meeting-requests/<ID>/confirm-best-slot


The response:

Includes the chosen slot (start, end).

Updates the MeetingRequest status accordingly.
